<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂØπËØùËÆ∞ÂΩïÂô®</title>
    <style>
        :root {
            --border-radius: 6px;
            --transition-speed: 0.2s;
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 0;
        }

        .header {
            padding: 15px 20px;
            background-color: var(--vscode-titleBar-activeBackground);
            border-bottom: 1px solid var(--vscode-panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--vscode-titleBar-activeForeground);
        }

        .stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-badge {
            background-color: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .search-panel {
            padding: 15px 20px;
            background-color: var(--vscode-panel-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            box-shadow: var(--shadow-light);
        }

        .search-input-container {
            position: relative;
            margin-bottom: 12px;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: all var(--transition-speed);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--vscode-focusBorder);
            box-shadow: 0 0 0 1px var(--vscode-focusBorder);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--vscode-input-placeholderForeground);
            pointer-events: none;
        }

        .search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap;
        }

        .filter-select {
            padding: 6px 8px;
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: var(--border-radius);
            min-width: 120px;
            font-size: 12px;
        }

        .search-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .search-button {
            padding: 6px 12px;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            transition: background-color var(--transition-speed);
        }

        .search-button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .search-button.secondary {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .search-button.secondary:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }

        .content-area {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 0;
        }

        .records-panel {
            flex: 1;
            overflow-y: auto;
            background-color: var(--vscode-panel-background);
        }

        .records-header {
            padding: 10px 20px;
            background-color: var(--vscode-panelSectionHeader-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-panelTitle-activeForeground);
        }

        .records-list {
            padding: 0;
        }

        .record-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--vscode-panel-border);
            cursor: pointer;
            transition: all var(--transition-speed);
            position: relative;
        }

        .record-item:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .record-item.selected {
            background-color: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            opacity: 1;
            background-color: var(--vscode-toolbar-hoverBackground);
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .record-item.selected::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--vscode-focusBorder);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .record-speaker {
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .speaker-user { background-color: var(--vscode-charts-blue); color: white; }
        .speaker-builder { background-color: var(--vscode-charts-green); color: white; }
        .speaker-chat { background-color: var(--vscode-charts-orange); color: white; }

        .record-time {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            opacity: 0.8;
        }

        .record-content {
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
            margin-bottom: 4px;
        }

        .record-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
        }

        .record-file {
            color: var(--vscode-textLink-foreground);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .record-type {
            background-color: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
        }

        .detail-panel {
            width: 40%;
            min-width: 300px;
            background-color: var(--vscode-panel-background);
            border-left: 1px solid var(--vscode-panel-border);
            display: flex;
            flex-direction: column;
        }

        .detail-header {
            padding: 15px 20px;
            background-color: var(--vscode-panelSectionHeader-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            font-size: 14px;
            font-weight: 600;
            color: var(--vscode-panelTitle-activeForeground);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-actions {
            display: flex;
            gap: 8px;
        }

        .detail-action {
            padding: 4px 8px;
            background: none;
            border: 1px solid var(--vscode-button-border);
            border-radius: 3px;
            color: var(--vscode-button-foreground);
            cursor: pointer;
            font-size: 11px;
            transition: all var(--transition-speed);
        }

        .detail-action:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .detail-content {
            flex: 1;
            padding: 15px 20px;
            overflow-y: auto;
            font-family: var(--vscode-editor-font-family);
            font-size: 13px;
            line-height: 1.5;
            color: var(--vscode-foreground);
        }

        .detail-item {
            display: flex;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .detail-item label {
            font-weight: 600;
            min-width: 80px;
            margin-right: 10px;
            color: var(--vscode-descriptionForeground);
        }

        .detail-item span {
            flex: 1;
            word-break: break-word;
        }

        .detail-item.full-width {
            flex-direction: column;
        }

        .detail-item.full-width label {
            margin-bottom: 5px;
        }

        .detail-item pre {
            margin: 0;
            padding: 8px;
            background-color: var(--vscode-textCodeBlock-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            font-family: var(--vscode-editor-font-family);
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .detail-section {
            margin: 15px 0;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 5px;
            overflow: hidden;
        }

        .detail-section-title {
            background-color: var(--vscode-panel-background);
            padding: 8px 12px;
            font-weight: 600;
            border-bottom: 1px solid var(--vscode-panel-border);
            color: var(--vscode-foreground);
        }

        .detail-section-content {
            padding: 12px;
            background-color: var(--vscode-editor-background);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
            font-family: var(--vscode-editor-font-family);
            font-size: 12px;
            line-height: 1.4;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .detail-header h3 {
            margin: 0;
            color: var(--vscode-foreground);
        }

        .detail-header .copy-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-section-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--vscode-foreground);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-section-content {
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: var(--border-radius);
            padding: 10px;
            font-size: 12px;
            line-height: 1.4;
            max-height: 150px;
            overflow-y: auto;
        }

        .no-records {
            text-align: center;
            padding: 60px 20px;
            color: var(--vscode-descriptionForeground);
        }

        .no-records-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--vscode-descriptionForeground);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--vscode-input-border);
            border-top: 2px solid var(--vscode-progressBar-background);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--vscode-descriptionForeground);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .empty-state-subtext {
            font-size: 12px;
            opacity: 0.7;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background-color: var(--vscode-notifications-background);
            color: var(--vscode-notifications-foreground);
            border: 1px solid var(--vscode-notifications-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.info {
            border-left: 4px solid var(--vscode-notificationsInfoIcon-foreground);
        }

        .notification.success {
            border-left: 4px solid var(--vscode-notificationsSuccessIcon-foreground);
        }

        .notification.warning {
            border-left: 4px solid var(--vscode-notificationsWarningIcon-foreground);
        }

        .notification.error {
            border-left: 4px solid var(--vscode-notificationsErrorIcon-foreground);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">ÂØπËØùËÆ∞ÂΩïÂô®</div>
            <div class="stats">
                <div class="stat-item">
                    <span>ÊÄªËÆ∞ÂΩï:</span>
                    <span class="stat-badge" id="totalRecords">0</span>
                </div>
                <div class="stat-item">
                    <span>‰ªäÊó•:</span>
                    <span class="stat-badge" id="todayRecords">0</span>
                </div>
                <div class="stat-item">
                    <span>‰ºöËØù:</span>
                    <span class="stat-badge" id="sessionCount">0</span>
                </div>
            </div>
        </div>

        <div class="search-panel">
            <div class="search-input-container">
                <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢ÂØπËØùËÆ∞ÂΩï...">
                <span class="search-icon">üîç</span>
            </div>
            <div class="search-filters">
                <div class="filter-group">
                    <span class="filter-label">ÂèëË®ÄËÄÖ:</span>
                    <select class="filter-select" id="speakerFilter">
                        <option value="">ÂÖ®ÈÉ®</option>
                        <option value="USER">Áî®Êà∑</option>
                        <option value="BUILDER">Builder</option>
                        <option value="CHAT">Chat</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Á±ªÂûã:</span>
                    <select class="filter-select" id="typeFilter">
                        <option value="">ÂÖ®ÈÉ®</option>
                        <option value="DIALOGUE">ÂØπËØù</option>
                        <option value="FILE_MODIFICATION">Êñá‰ª∂‰øÆÊîπ</option>
                        <option value="UNDO">Êí§ÈîÄÊìç‰Ωú</option>
                        <option value="REDO">ÈáçÂÅöÊìç‰Ωú</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">ÂºÄÂßã:</span>
                    <input type="date" class="filter-select" id="startDate">
                </div>
                <div class="filter-group">
                    <span class="filter-label">ÁªìÊùü:</span>
                    <input type="date" class="filter-select" id="endDate">
                </div>
                <div class="search-buttons">
                    <button class="search-button" id="searchButton">ÊêúÁ¥¢</button>
                    <button class="search-button secondary" id="clearButton">Ê∏ÖÈô§</button>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="records-panel">
                <div class="records-header">
                    ÂØπËØùËÆ∞ÂΩï
                </div>
                <div class="records-list" id="recordsList">
                    <div class="no-records" id="noRecords">
                        <div class="no-records-icon">üìù</div>
                        <div>ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï</div>
                        <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">ÂºÄÂßãÂØπËØùÂêéËÆ∞ÂΩïÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</div>
                    </div>
                    <div class="loading" id="loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div>Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
            </div>

            <div class="detail-panel" id="detailPanel" style="display: none;">
                <div class="detail-header">
                    <span>ËØ¶ÁªÜ‰ø°ÊÅØ</span>
                    <div class="detail-actions">
                        <button class="detail-action" id="copyButton">Â§çÂà∂</button>
                        <button class="detail-action" id="exportButton">ÂØºÂá∫</button>
                    </div>
                </div>
                <div class="detail-content" id="detailContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">ÈÄâÊã©‰∏ÄÊù°ËÆ∞ÂΩïÊü•ÁúãËØ¶ÊÉÖ</div>
                        <div class="empty-state-subtext">ÁÇπÂáªÂ∑¶‰æßÁöÑËÆ∞ÂΩï‰ª•Êü•ÁúãÂÆåÊï¥‰ø°ÊÅØ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        // DOMÂÖÉÁ¥†
        const searchInput = document.getElementById('searchInput');
        const speakerFilter = document.getElementById('speakerFilter');
        const typeFilter = document.getElementById('typeFilter');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        const searchButton = document.getElementById('searchButton');
        const clearButton = document.getElementById('clearButton');
        const copyButton = document.getElementById('copyButton');
        const exportButton = document.getElementById('exportButton');
        const recordsPanel = document.getElementById('recordsList');
        const recordsList = document.getElementById('recordsList');
        const noRecords = document.getElementById('noRecords');
        const loading = document.getElementById('loading');
        const detailPanel = document.getElementById('detailPanel');
        const detailContent = document.getElementById('detailContent');
        const totalRecords = document.getElementById('totalRecords');
        const todayRecords = document.getElementById('todayRecords');
        const sessionCount = document.getElementById('sessionCount');

        let currentRecords = [];
        let selectedRecord = null;
        let currentSessionId = null;

        // ‰∫ã‰ª∂ÁõëÂê¨
        searchButton.addEventListener('click', performSearch);
        clearButton.addEventListener('click', clearSearch);
        copyButton.addEventListener('click', () => {
            if (selectedRecord) {
                copyRecordContent(selectedRecord);
            } else {
                showNotification('ËØ∑ÂÖàÈÄâÊã©‰∏ÄÊù°ËÆ∞ÂΩï');
            }
        });
        exportButton.addEventListener('click', exportRecords);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // ÂàùÂßãÂåñ
        window.addEventListener('load', () => {
            loadRecords();
        });

        // ÁõëÂê¨Êù•Ëá™Êâ©Â±ïÁöÑÊ∂àÊÅØ
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Webview: Êî∂Âà∞Êù•Ëá™Êâ©Â±ïÁöÑÊ∂àÊÅØ:', message.type);
            
            switch (message.type) {
                case 'recordsLoaded':
                    console.log('Webview: Êî∂Âà∞recordsLoadedÊ∂àÊÅØÔºåËÆ∞ÂΩïÊï∞Èáè:', message.records ? message.records.length : 0);
                    hideLoading();
                    displayRecords(message.records);
                    break;
                case 'searchResults':
                    console.log('Webview: Êî∂Âà∞searchResultsÊ∂àÊÅØÔºåËÆ∞ÂΩïÊï∞Èáè:', message.results ? message.results.length : 0);
                    hideLoading();
                    displayRecords(message.results);
                    break;
                case 'newRecord':
                    console.log('Webview: Êî∂Âà∞newRecordÊ∂àÊÅØ');
                    addNewRecord(message.record);
                    break;
                case 'error':
                    console.log('Webview: Êî∂Âà∞ÈîôËØØÊ∂àÊÅØ:', message.text);
                    hideLoading();
                    showNotification(message.text, 'error');
                    break;
                default:
                    console.log('Webview: Êî∂Âà∞Êú™Áü•Á±ªÂûãÁöÑÊ∂àÊÅØ:', message.type);
            }
        });

        function performSearch() {
            const keyword = searchInput.value.trim();
            const speaker = speakerFilter.value;
            const type = typeFilter.value;
            const start = startDate.value;
            const end = endDate.value;

            showLoading();
            
            vscode.postMessage({
                type: 'search',
                keyword: keyword,
                speaker: speaker,
                recordType: type,
                startTime: start ? new Date(start) : null,
                endTime: end ? new Date(end) : null
            });
        }

        function clearSearch() {
            searchInput.value = '';
            speakerFilter.value = '';
            typeFilter.value = '';
            startDate.value = '';
            endDate.value = '';
            loadRecords();
        }

        function loadRecords() {
            console.log('Webview: ÂºÄÂßãÂä†ËΩΩËÆ∞ÂΩï');
            showLoading();
            vscode.postMessage({ type: 'loadRecords' });
            console.log('Webview: Â∑≤ÂèëÈÄÅloadRecordsÂëΩ‰ª§Âà∞Êâ©Â±ï');
        }

        function showLoading() {
            noRecords.style.display = 'none';
            loading.style.display = 'block';
            recordsList.innerHTML = '';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function displayRecords(records) {
            loading.style.display = 'none';
            recordsList.innerHTML = '';
            currentRecords = records || [];

            if (currentRecords.length === 0) {
                recordsList.style.display = 'none';
                noRecords.style.display = 'block';
                detailPanel.style.display = 'none';
                return;
            }

            recordsList.style.display = 'block';
            noRecords.style.display = 'none';

            currentRecords.forEach((record, index) => {
                const recordElement = createRecordElement(record, index);
                recordsList.appendChild(recordElement);
            });
            
            updateStatistics(currentRecords);
        }

        function createRecordElement(record, index) {
            const div = document.createElement('div');
            div.className = 'record-item';
            if (selectedRecord && selectedRecord.id === record.id) {
                div.classList.add('selected');
            }

            const timeString = new Date(record.timestamp).toLocaleString('zh-CN');
            
            div.innerHTML = `
                <div class="record-header">
                    <span class="record-speaker speaker-${record.speaker.toLowerCase()}">${getSpeakerDisplayName(record.speaker)}</span>
                    <span class="record-time">${timeString}</span>
                    <button class="copy-btn" onclick="event.stopPropagation(); copyRecordContent(${JSON.stringify(record).replace(/"/g, '&quot;')})">
                        <span class="codicon codicon-copy"></span>
                    </button>
                </div>
                <div class="record-content">${escapeHtml(record.content.substring(0, 100))}${record.content.length > 100 ? '...' : ''}</div>
            `;

            div.addEventListener('click', () => {
                selectRecord(record, index);
            });

            return div;
        }

        function selectRecord(record, index) {
            // ÁßªÈô§‰πãÂâçÈÄâ‰∏≠ÁöÑÊ†∑Âºè
            document.querySelectorAll('.record-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ†∑Âºè
            document.querySelectorAll('.record-item')[index].classList.add('selected');
            
            selectedRecord = record;
            showDetail(record);
        }

        function showDetail(record) {
            detailPanel.style.display = 'block';
            
            const timeString = new Date(record.timestamp).toLocaleString();
            
            // ÊûÑÂª∫ËØ¶ÁªÜ‰ø°ÊÅØHTML
            let detailHtml = `
                <div class="detail-header">
                    <h3>ËÆ∞ÂΩïËØ¶ÊÉÖ</h3>
                    <button class="copy-btn" onclick="copyRecordContent(${JSON.stringify(record).replace(/"/g, '&quot;')})">
                        <span class="codicon codicon-copy"></span> Â§çÂà∂
                    </button>
                </div>
                <div class="detail-content">
                    <div class="detail-item">
                        <label>ËÆ∞ÂΩïID:</label>
                        <span>${record.id}</span>
                    </div>
                    <div class="detail-item">
                        <label>‰ºöËØùID:</label>
                        <span>${record.sessionId}</span>
                    </div>
                    <div class="detail-item">
                        <label>Á±ªÂûã:</label>
                        <span>${formatRecordType(record.recordType)}</span>
                    </div>
                    <div class="detail-item">
                        <label>ÂèëË®ÄËÄÖ:</label>
                        <span>${formatSpeakerName(record.speaker)}</span>
                    </div>
                    <div class="detail-item">
                        <label>Êó∂Èó¥:</label>
                        <span>${timeString}</span>
                    </div>`;

            // Â¶ÇÊûúÊòØÊñá‰ª∂‰øÆÊîπÁ±ªÂûãÔºåÊòæÁ§∫Êñá‰ª∂Áõ∏ÂÖ≥‰ø°ÊÅØ
            if (record.filePath) {
                detailHtml += `
                    <div class="detail-item">
                        <label>Êñá‰ª∂Ë∑ØÂæÑ:</label>
                        <span>${escapeHtml(record.filePath)}</span>
                    </div>`;
            }

            if (record.modificationType) {
                detailHtml += `
                    <div class="detail-item">
                        <label>‰øÆÊîπÁ±ªÂûã:</label>
                        <span>${formatModificationType(record.modificationType)}</span>
                    </div>`;
            }

            // ÊòæÁ§∫‰∏ªË¶ÅÂÜÖÂÆπ
            detailHtml += `
                    <div class="detail-section">
                        <div class="detail-section-title">ÂÜÖÂÆπ</div>
                        <div class="detail-section-content">${escapeHtml(record.content)}</div>
                    </div>`;

            // Â¶ÇÊûúÊòØÊñá‰ª∂‰øÆÊîπÔºåÊòæÁ§∫ÊóßÂÜÖÂÆπÂíåÊñ∞ÂÜÖÂÆπÁöÑÂØπÊØî
            if (record.oldContent || record.newContent) {
                detailHtml += `
                    <div class="detail-section">
                        <div class="detail-section-title">‰øÆÊîπËØ¶ÊÉÖ</div>`;
                
                if (record.oldContent) {
                    detailHtml += `
                        <div class="detail-item">
                            <label>ÊóßÂÜÖÂÆπ:</label>
                            <pre>${escapeHtml(record.oldContent)}</pre>
                        </div>`;
                }
                
                if (record.newContent) {
                    detailHtml += `
                        <div class="detail-item">
                            <label>Êñ∞ÂÜÖÂÆπ:</label>
                            <pre>${escapeHtml(record.newContent)}</pre>
                        </div>`;
                }
                
                detailHtml += `
                    </div>`;
            }

            // ÊòæÁ§∫Êìç‰ΩúËØ¶ÊÉÖ
            if (record.operationDetails) {
                detailHtml += `
                    <div class="detail-section">
                        <div class="detail-section-title">Êìç‰ΩúËØ¶ÊÉÖ</div>
                        <div class="detail-section-content">${escapeHtml(record.operationDetails)}</div>
                    </div>`;
            }

            detailHtml += `
                </div>`;
            
            detailContent.innerHTML = detailHtml;
        }

        function addNewRecord(record) {
            if (noRecords.style.display !== 'none') {
                noRecords.style.display = 'none';
            }
            
            const recordElement = createRecordElement(record, currentRecords.length);
            recordsList.insertBefore(recordElement, recordsList.firstChild);
            currentRecords.unshift(record);
        }

        function getSpeakerDisplayName(speaker) {
            switch (speaker) {
                case 'USER': return 'Áî®Êà∑';
                case 'BUILDER': return 'Builder';
                case 'CHAT': return 'Chat';
                default: return speaker;
            }
        }

        function formatRecordType(recordType) {
            switch (recordType) {
                case 'DIALOGUE': return 'ÂØπËØù';
                case 'FILE_MODIFICATION': return 'Êñá‰ª∂‰øÆÊîπ';
                case 'UNDO': return 'Êí§ÈîÄÊìç‰Ωú';
                case 'REDO': return 'ÈáçÂÅöÊìç‰Ωú';
                default: return recordType;
            }
        }

        function formatModificationType(modificationType) {
            switch (modificationType) {
                case 'CREATE': return 'ÂàõÂª∫Êñá‰ª∂';
                case 'UPDATE': return 'Êõ¥Êñ∞Êñá‰ª∂';
                case 'DELETE': return 'Âà†Èô§Êñá‰ª∂';
                case 'RENAME': return 'ÈáçÂëΩÂêçÊñá‰ª∂';
                default: return modificationType;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStatistics(records) {
            const today = new Date().toISOString().split('T')[0];
            const todayCount = records.filter(record => record.timestamp.startsWith(today)).length;
            const sessions = [...new Set(records.map(record => record.sessionId))];
            
            totalRecords.textContent = records.length;
            todayRecords.textContent = todayCount;
            sessionCount.textContent = sessions.length;
        }

        // Â§çÂà∂ËÆ∞ÂΩïÂÜÖÂÆπ
        function copyRecordContent(record) {
            const content = `ËÆ∞ÂΩïÁ±ªÂûã: ${formatRecordType(record.recordType)}
ÂèëË®ÄËÄÖ: ${formatSpeakerName(record.speaker)}
Êó∂Èó¥: ${new Date(record.timestamp).toLocaleString()}
ÂÜÖÂÆπ: ${record.content}`;
            
            navigator.clipboard.writeText(content).then(() => {
                showNotification('ËÆ∞ÂΩïÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            }).catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                showNotification('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            });
        }

        // ÂØºÂá∫ËÆ∞ÂΩï
        function exportRecords() {
            if (currentRecords.length === 0) {
                showNotification('Ê≤°ÊúâËÆ∞ÂΩïÂèØÂØºÂá∫');
                return;
            }
            
            vscode.postMessage({
                command: 'exportRecords',
                records: currentRecords
            });
        }

        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>